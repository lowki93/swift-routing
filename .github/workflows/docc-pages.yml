name: Deploy DocC (Versioned)

on:
  push:
    tags:
      - '*.*.0'
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: gh-pages
  cancel-in-progress: false

jobs:
  build-and-publish:
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode 26.2
        uses: ./.github/actions/setup-xcode-26-2

      - name: Determine version
        id: version
        run: |
          if [[ "${GITHUB_REF_NAME}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "version=${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          else
            # For manual dispatch, use latest tag or fallback
            LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
            echo "version=${LATEST_TAG}" >> $GITHUB_OUTPUT
          fi

      - name: Build DocC
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          REPO_NAME="${GITHUB_REPOSITORY##*/}"
          OUTPUT_DIR="build/docc"

          rm -rf "${OUTPUT_DIR}"
          mkdir -p "${OUTPUT_DIR}"

          swift package \
            --allow-writing-to-directory "${OUTPUT_DIR}" \
            generate-documentation \
            --target SwiftRouting \
            --output-path "${OUTPUT_DIR}" \
            --transform-for-static-hosting \
            --hosting-base-path "swift-routing/${VERSION}"

      - name: Inject version switcher
        run: |
          set -euo pipefail
          OUTPUT_DIR="build/docc"
          BASE_PATH="/${GITHUB_REPOSITORY##*/}/"

          python3 - <<PY
          import os

          base_path = "${BASE_PATH}"
          marker = "docc-version-switcher"
          css = f"""
          <style id="{marker}-style">
            .docc-version-banner {{
              position: fixed;
              top: 0;
              left: 0;
              right: 0;
              height: 32px;
              background: linear-gradient(90deg, #1a1a2e 0%, #16213e 100%);
              display: flex;
              align-items: center;
              justify-content: center;
              gap: 8px;
              z-index: 99999;
              font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
              font-size: 13px;
              color: rgba(255, 255, 255, 0.9);
              box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            }}
            .docc-version-banner .banner-label {{
              font-weight: 400;
            }}
            .docc-version-banner select {{
              background: rgba(255, 255, 255, 0.1);
              color: #fff;
              border: 1px solid rgba(255, 255, 255, 0.2);
              border-radius: 4px;
              padding: 3px 8px;
              cursor: pointer;
              font-size: 12px;
              font-weight: 500;
            }}
            .docc-version-banner select:hover {{
              background: rgba(255, 255, 255, 0.15);
            }}
            .docc-version-banner select:focus {{
              outline: none;
            }}
            body {{
              padding-top: 32px !important;
            }}
            nav.nav, .nav--in-breakpoint-container, header {{
              top: 32px !important;
            }}
          </style>
          """
          js = f"""
          <script id="{marker}">
          (function() {{
            const basePath = "{base_path}";
            const currentPath = window.location.pathname;
            const parts = currentPath.split("/").filter(Boolean);
            const repo = basePath.replace(/^\\//, "").replace(/\\/$/, "");
            const repoIndex = parts.indexOf(repo);
            let currentVersion = "";
            if (repoIndex >= 0 && parts.length > repoIndex + 1) {{
              const candidate = parts[repoIndex + 1];
              if (/^\\d+\\.\\d+\\.\\d+$/.test(candidate)) {{
                currentVersion = candidate;
              }}
            }}

            const banner = document.createElement("div");
            banner.className = "docc-version-banner";
            banner.innerHTML = '<span class="banner-label">SwiftRouting</span><select id="docc-version-select" aria-label="Version"></select>';
            document.body.insertBefore(banner, document.body.firstChild);

            fetch(basePath + "versions.json", {{ cache: "no-store" }})
              .then(r => r.json())
              .then(data => {{
                const select = document.getElementById("docc-version-select");
                const versions = (data.versions || []).slice().reverse();
                versions.forEach(v => {{
                  const opt = document.createElement("option");
                  opt.value = v;
                  opt.textContent = v + (v === data.latest ? " · latest" : "");
                  if (v === currentVersion) opt.selected = true;
                  select.appendChild(opt);
                }});
                select.addEventListener("change", () => {{
                  const v = select.value;
                  if (!v) return;
                  if (currentVersion) {{
                    window.location.href = currentPath.replace("/" + currentVersion + "/", "/" + v + "/");
                  }} else {{
                    window.location.href = basePath + v + "/documentation/swiftrouting/";
                  }}
                }});
              }})
              .catch(() => {{}});
          }})();
          </script>
          """

          for root, _, files in os.walk("${OUTPUT_DIR}"):
            for name in files:
              if not name.endswith(".html"):
                continue
              path = os.path.join(root, name)
              with open(path, "r", encoding="utf-8") as f:
                content = f.read()
              if marker in content:
                continue
              if "</head>" in content:
                content = content.replace("</head>", css + "\\n</head>")
              if "</body>" in content:
                content = content.replace("</body>", js + "\\n</body>")
              with open(path, "w", encoding="utf-8") as f:
                f.write(content)
          PY

      - name: Publish to gh-pages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.version.outputs.version }}"
          OUTPUT_DIR="build/docc"
          PUBLISH_DIR=".publish"
          REPO="${GITHUB_REPOSITORY}"
          REMOTE="https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git"

          rm -rf "${PUBLISH_DIR}"
          mkdir -p "${PUBLISH_DIR}"
          cd "${PUBLISH_DIR}"

          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add origin "${REMOTE}"

          if git fetch origin gh-pages; then
            git checkout -b gh-pages origin/gh-pages
          else
            git checkout --orphan gh-pages
            git rm -rf . >/dev/null 2>&1 || true
          fi

          touch .nojekyll

          rm -rf "${VERSION}"
          mkdir -p "${VERSION}"
          cp -R "../${OUTPUT_DIR}/." "${VERSION}/"

          LATEST=$(python3 - <<'PY'
          import json, os, re
          versions = [
              d for d in os.listdir(".")
              if os.path.isdir(d) and re.match(r"^\d+\.\d+\.\d+$", d)
          ]
          versions.sort(key=lambda s: [int(x) for x in s.split(".")])
          latest = versions[-1] if versions else ""
          with open("versions.json", "w") as f:
              json.dump({"latest": latest, "versions": versions}, f)
          print(latest)
          PY
          )

          python3 - <<PY
          import html, json
          latest = "${LATEST}"
          with open("versions.json") as f:
            data = json.load(f)
          versions = data.get("versions", [])
          items = "\\n".join(
            f'<li><a href="./{v}/documentation/swiftrouting/">v{html.escape(v)}</a></li>' for v in versions[::-1]
          )
          html_out = f"""<!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>SwiftRouting Docs Versions</title>
            <style>
              :root {{ color-scheme: light dark; }}
              body {{ font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif; margin: 48px auto; max-width: 720px; padding: 0 20px; }}
              h1 {{ font-size: 28px; margin-bottom: 8px; }}
              .meta {{ color: #666; font-size: 14px; margin-bottom: 20px; }}
              ul {{ padding-left: 18px; }}
              a {{ color: #1b6ef3; text-decoration: none; }}
              a:hover {{ text-decoration: underline; }}
              .latest {{ font-weight: 600; }}
            </style>
          </head>
          <body>
            <h1>SwiftRouting Documentation Versions</h1>
            <div class="meta">Latest: <span class="latest">{html.escape(latest)}</span></div>
            <ul>{items}</ul>
          </body>
          </html>"""
          with open("versions.html", "w") as f:
            f.write(html_out)
          PY

          cat > index.html <<EOF
          <!doctype html>
          <html lang="en">
          <head>
            <meta charset="utf-8">
            <meta http-equiv="refresh" content="0; url=./${LATEST}/documentation/swiftrouting/">
            <link rel="canonical" href="./${LATEST}/documentation/swiftrouting/">
            <title>Redirecting to latest documentation…</title>
            <script>window.location.replace("./${LATEST}/documentation/swiftrouting/");</script>
          </head>
          <body>
            <p>Redirecting to <a href="./${LATEST}/documentation/swiftrouting/">latest documentation</a>…</p>
          </body>
          </html>
          EOF

          git add -A
          git commit -m "docs: v${VERSION}" || echo "No changes to commit"
          git push origin gh-pages
